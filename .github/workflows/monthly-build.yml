name: Monthly image build, tagging, and cleanup

on:
  schedule:
    - cron: "0 3 1 * *"
  workflow_dispatch: {}

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}  
  KEEP_VERSIONS: 2  

jobs:
  build-tag-clean:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image locally
        run: |
          docker build -t tg-build-temp .

      - name: Debug Twingate install in image
        run: |
          echo "Checking twingate inside tg-build-temp..."
          docker run --rm tg-build-temp sh -lc 'which twingate || echo "twingate not in PATH"; ls -R /usr/local /usr/bin /bin | head -n 100'

      - name: Extract Twingate client version from image
        id: version
        run: |
          # Temporarily disable 'exit on error' so we can inspect failures
          set +e
          RAW_OUTPUT=$(docker run --rm tg-build-temp sh -lc "twingate version | head -n 1")
          STATUS=$?
          set -e

          echo "RAW_OUTPUT (exit $STATUS): $RAW_OUTPUT"

          if [ $STATUS -ne 0 ] || [ -z "$RAW_OUTPUT" ]; then
            echo "WARNING: Failed to run 'twingate version' in the image."
            echo "Falling back to 'unknown' client version."
            CLIENT_VER="unknown"
          else
            # Expected: 'twingate 2025.310.174671 | 0.174.0'
            CLIENT_VER=$(echo "$RAW_OUTPUT" | awk '{print $2}')
            if [ -z "$CLIENT_VER" ]; then
              CLIENT_VER="unknown"
            fi
          fi

          echo "Parsed client version: $CLIENT_VER"
          echo "TG_CLIENT_VERSION=$CLIENT_VER" >> "$GITHUB_ENV"


      - name: Tag image
        run: |
          FULL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          docker tag tg-build-temp "$FULL:latest"
          docker tag tg-build-temp "$FULL:tg-client-${TG_CLIENT_VERSION}"

      - name: Push images
        run: |
          FULL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          docker push "$FULL:latest"
          docker push "$FULL:tg-client-${TG_CLIENT_VERSION}"

      - name: Cleanup old versioned tags
        run: |
          FULL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"

          echo "Fetching all tg-client-* tags..."
          TAGS=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/${{ github.event.repository.name }}/versions" | \
            jq -r '.[].metadata.container.tags[]' | grep '^tg-client-' || true)

          echo "Found tags:"
          echo "$TAGS"

          # Sort descending by version number (string sort works for YYYY.MMDD.build formats)
          SORTED=$(echo "$TAGS" | sort -r)

          # Keep the first N tags, delete the rest
          KEEP=$((KEEP_VERSIONS))
          TO_DELETE=$(echo "$SORTED" | tail -n +$((KEEP + 1)))

          echo "Tags to keep:"
          echo "$SORTED" | head -n "$KEEP"

          echo "Tags to delete:"
          echo "$TO_DELETE"

          if [ -z "$TO_DELETE" ]; then
            echo "No tags to delete."
            exit 0
          fi

          # Delete each old tag through GH API
          for TAG in $TO_DELETE; do
            echo "Deleting $TAG ..."
            
            VERSION_ID=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/${{ github.event.repository.name }}/versions" | \
              jq -r --arg TAG "$TAG" '.[] | select(.metadata.container.tags[]? == $TAG) | .id')

            if [ -n "$VERSION_ID" ]; then
              curl -X DELETE \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/orgs/${{ github.repository_owner }}/packages/container/${{ github.event.repository.name }}/versions/$VERSION_ID"
              echo "Deleted version ID $VERSION_ID ($TAG)"
            else
              echo "Could not find version ID for tag $TAG"
            fi
          done
